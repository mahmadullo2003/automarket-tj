<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMarket Pro - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞–∏ –ö–∞—Å–±”£</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #1a252f; --accent: #f39c12; --success: #27ae60; --danger: #e74c3c; --light: #ecf0f1; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f8f9fa; color: #333; }
        
        nav { background: var(--primary); color: white; padding: 1rem 5%; display: flex; justify-content: space-between; 

align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; cursor: pointer; transition: 0.3s; }
        .nav-links a:hover { color: var(--accent); }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        .stats-bar { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 20px; 

box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-item { flex: 1; text-align: center; border-right: 1px solid #eee; }
        .stat-item:last-child { border: none; }
        .stat-value { display: block; font-size: 1.2rem; font-weight: bold; color: var(--success); }
        .stat-label { font-size: 0.8rem; color: #7f8c8d; }

        .search-box { margin-bottom: 25px; display: flex; gap: 10px; }
        .search-box input, .search-box select { padding: 12px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        .search-box input { flex: 3; }
        .search-box select { flex: 1; }

        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.08); 

transition: transform 0.3s; position: relative; border: 1px solid #eee; }
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        .card-body { padding: 15px; }
        .card-tag { background: var(--primary); color: white; padding: 3px 10px; border-radius: 5px; font-size: 0.7rem; 

position: absolute; top: 10px; left: 10px; }
        .type-tag { background: var(--accent); color: white; padding: 3px 10px; border-radius: 5px; font-size: 0.7rem; 

position: absolute; top: 10px; right: 10px; }
        
        .price { font-size: 1.3rem; color: var(--success); font-weight: bold; margin: 5px 0; }
        .info-row { font-size: 0.85rem; margin-bottom: 4px; display: flex; justify-content: space-between; }
        
        .btn-group { display: flex; gap: 8px; margin-top: 10px; }
        .btn-wa { background: #25d366; color: white; text-decoration: none; padding: 10px; border-radius: 8px; flex: 1; 

text-align: center; font-weight: bold; font-size: 0.9rem; }
        .btn-call { background: #3498db; color: white; text-decoration: none; padding: 10px; border-radius: 8px; flex: 1; 

text-align: center; font-weight: bold; font-size: 0.9rem; }
        
        .admin-panel { background: #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid 

#2196f3; }
        .user-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ddd; 

background: white; margin-bottom: 5px; border-radius: 5px; }
        
        .hidden { display: none !important; }
        .modal { background: white; padding: 25px; border-radius: 15px; max-width: 500px; margin: 20px auto; box-shadow: 0 

10px 30px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-

sizing: border-box; }
    </style>
</head>
<body>

<nav>
    <div style="font-size: 1.5rem; font-weight: bold; cursor:pointer" onclick="app.showPage('home')">Auto<span 

style="color:var(--accent)">Market</span></div>
    <div class="nav-links">
        <a onclick="app.showPage('home')">üè† –ê—Å–æ—Å”£</a>
        <a onclick="app.showPage('add')" id="addBtn" class="hidden">‚ûï –≠—ä–ª–æ–Ω</a>
        <a onclick="app.showPage('login')" id="loginLink">üîë –í–æ—Ä–∏–¥—à–∞–≤”£</a>
        <span id="userInfo" style="font-size: 0.85rem; color: #bdc3c7;"></span>
        <a onclick="app.logout()" id="logoutLink" class="hidden">üö™ –ë–∞—Ä–æ–º–∞–¥</a>
    </div>
</nav>

<div class="container">
    <div id="statsSection" class="stats-bar hidden">
        <div class="stat-item">
            <span class="stat-value" id="userItemsCount">0</span>
            <span class="stat-label">–ú–æ–ª“≥–æ–∏ —à—É–º–æ</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="userTotalSum">0 c.</span>
            <span class="stat-label">–ú–∞–±–ª–∞“ì–∏ —É–º—É–º”£</span>
        </div>
    </div>

    <div id="searchArea" class="search-box">
        <input type="text" id="searchInput" placeholder="üîç –ù–æ–º–∏ –∑–∞–ø—á–∞—Å—Ç —ë –º–æ—à–∏–Ω..." onkeyup="app.filterProducts()">
        <select id="typeFilter" onchange="app.filterProducts()">
            <option value="">“≤–∞–º–∞–∏ —Ç–∏–ø“≥–æ</option>
            <option value="–•–æ–¥–æ–≤–æ–π">–•–æ–¥–æ–≤–æ–π</option>
            <option value="–≠–ª–µ–∫—Ç—Ä–æ–Ω”£">–≠–ª–µ–∫—Ç—Ä–æ–Ω”£</option>
            <option value="–ú–æ—Ç–æ—Ä">–ú–æ—Ç–æ—Ä</option>
            <option value="–ö—É–∑–æ–≤">–ö—É–∑–æ–≤</option>
        </select>
    </div>

    <div id="adminPanel" class="admin-panel hidden">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <h3 style="margin-top:0">üë• –ò–¥–æ—Ä–∞–∫—É–Ω–∏–∏ –ò—Å—Ç–∏—Ñ–æ–¥–∞–±–∞—Ä–∞–Ω–¥–∞–≥–æ–Ω (–ê–¥–º–∏–Ω)</h3>
            <div style="text-align:right">
                <span style="color:#2196f3; font-weight:bold">–°—É–º–º–∞–∏ —É–º—É–º–∏–∏ –±–∞–∑–∞: </span>
                <span id="adminGrandTotal" style="color:var(--success); font-size:1.2rem; font-weight:bold">0 c.</span>
            </div>
        </div>
        <div id="allUsersList"></div>
    </div>

    <div id="homePage">
        <div id="adsGrid" class="ads-grid"></div>
    </div>

    <div id="loginPage" class="hidden">
        <div class="modal">
            <h2>–í–æ—Ä–∏–¥—à–∞–≤”£</h2>
            <input type="text" id="regName" placeholder="–ù–æ–º–∏ –ø—É—Ä—Ä–∞">
            <input type="number" id="regPhone" placeholder="933XXXXXX">
            <button onclick="app.handleAuth()" style="width:100%; padding:12px; margin-top:15px; background:var(--success); 

color:white; border:none; border-radius:8px; cursor:pointer">–î–∞–≤–æ–º –¥–æ–¥–∞–Ω</button>
        </div>
    </div>

    <div id="addPage" class="hidden">
        <div class="modal">
            <h2>üì¶ –≠—ä–ª–æ–Ω–∏ –Ω–∞–≤</h2>
            
            <label>–¢–∞–º“ì–∞–∏ –º–æ—à–∏–Ω (–ú–∞—Ä–∫–∞)</label>
            <select id="pCarBrand" onchange="app.updateModels()">
                <option value="">-- –ò–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥ --</option>
                <option value="Opel">Opel</option>
                <option value="Toyota">Toyota</option>
                <option value="Mercedes-Benz">Mercedes-Benz</option>
                <option value="BMW">BMW</option>
                <option value="Hyundai">Hyundai</option>
                <option value="Kia">Kia</option>
                <option value="SsangYong">SsangYong</option>
                <option value="LADA">LADA</option>
            </select>

            <label>–ú–æ–¥–µ–ª–∏ –º–æ—à–∏–Ω</label>
            <select id="pCarModel">
                <option value="">-- –ê–≤–≤–∞–ª –º–∞—Ä–∫–∞—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥ --</option>
            </select>
            
            <label>–°–æ–ª–∏ –º–æ—à–∏–Ω</label>
            <select id="pCarYear"></select>

            <label>–¢–∏–ø–∏ –º–∞“≥—Å—É–ª–æ—Ç</label>
            <select id="pType">
                <option value="–•–æ–¥–æ–≤–æ–π">–•–æ–¥–æ–≤–æ–π</option>
                <option value="–≠–ª–µ–∫—Ç—Ä–æ–Ω”£">–≠–ª–µ–∫—Ç—Ä–æ–Ω”£</option>
                <option value="–ú–æ—Ç–æ—Ä">–ú–æ—Ç–æ—Ä</option>
                <option value="–ö—É–∑–æ–≤">–ö—É–∑–æ–≤</option>
                <option value="–î–∏–≥–∞—Ä">–î–∏–≥–∞—Ä</option>
            </select>

            <label>–ù–æ–º–∏ –∑–∞–ø—á–∞—Å—Ç</label>
            <input type="text" id="pName" placeholder="–ú–∞—Å–∞–ª–∞–Ω: –†–∞–¥–∏–∞—Ç–æ—Ä">

            <label>–ù–∞—Ä—Ö (—Å–æ–º–æ–Ω”£)</label>
            <input type="number" id="pPrice">

            <label>–ú–∏“õ–¥–æ—Ä</label>
            <input type="number" id="pQty" value="1">

            <label>–î–æ—Å—Ç–∞–≤–∫–∞ (–∞–∑ - —Ç–æ)</label>
            <input type="text" id="pDelivery" placeholder="–ú–∞—Å–∞–ª–∞–Ω: –•—É“∑–∞–Ω–¥ - –î—É—à–∞–Ω–±–µ">

            <label>–ú”Ø“≥–ª–∞—Ç–∏ –∫–∞—Ñ–æ–ª–∞—Ç (–±–æ —Ä”Ø–∑)</label>
            <input type="number" id="pWarranty" placeholder="–ú–∞—Å–∞–ª–∞–Ω: 30">

            <label>–°—É—Ä–∞—Ç</label>
            <input type="file" id="pImg" accept="image/*">

            <button onclick="app.addProduct()" style="width:100%; padding:12px; margin-top:20px; background:var(--accent); 

color:white; border:none; border-radius:8px; cursor:pointer">–ù–∞—à—Ä –∫–∞—Ä–¥–∞–Ω</button>
        </div>
    </div>
</div>

<script>
    const ADMIN_PHONE = "933099029"; 
    const firebaseConfig = {
        apiKey: "AIzaSy...", 
        authDomain: "automarkettj.firebaseapp.com",
        databaseURL: "https://automarkettj-default-rtdb.firebaseio.com/",
        projectId: "automarkettj",
        storageBucket: "automarkettj.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const app = {
        currentUser: JSON.parse(localStorage.getItem('activeUser')),
        allProducts: [],
        
        carDatabase: {
            "Opel": ["Astra G", "Astra H", "Vectra B", "Vectra C", "Zafira A", "Zafira B", "Corsa"],
            "Toyota": ["Camry 50", "Camry 55", "Camry 70", "Corolla", "Rav4", "Avalon", "Prado"],
            "Mercedes-Benz": ["W210 (Chashmaka)", "W211", "W212", "W202", "W203", "W204", "Sprinter"],
            "BMW": ["E34", "E39", "E60", "F10", "X5 E53", "X5 E70", "X6"],
            "Hyundai": ["Elantra", "Sonata", "Solaris", "Accent", "Tucson", "Santa Fe"],
            "Kia": ["Optima", "K5", "Rio", "Sportage", "Sorento"],
            "SsangYong": ["Musso", "Korando", "Rexton", "Kyron"],
            "LADA": ["Priora", "Vesta", "Granta", "Niva", "2107", "2114"]
        },

        init() {
            this.checkUserStatus();
            this.loadProducts();
            this.fillYears();
            if(this.currentUser) {
                document.getElementById('statsSection').classList.remove('hidden');
                if(this.currentUser.phone === ADMIN_PHONE) this.loadAdminUsers();
            }
        },

        showPage(pageId) {
            ['home', 'login', 'add'].forEach(p => document.getElementById(p + 'Page').classList.add('hidden'));
            document.getElementById(pageId + 'Page').classList.remove('hidden');
            document.getElementById('searchArea').classList.toggle('hidden', pageId !== 'home');
        },

        fillYears() {
            const yearSelect = document.getElementById('pCarYear');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= 1990; i--) {
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = i;
                yearSelect.appendChild(opt);
            }
        },

        updateModels() {
            const brand = document.getElementById('pCarBrand').value;
            const modelSelect = document.getElementById('pCarModel');
            modelSelect.innerHTML = brand ? "" : '<option value="">-- –ê–≤–≤–∞–ª –º–∞—Ä–∫–∞—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥ --</option>';
            if (this.carDatabase[brand]) {
                this.carDatabase[brand].forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m; opt.innerText = m;
                    modelSelect.appendChild(opt);
                });
            }
        },

        async handleAuth() {
            const name = document.getElementById('regName').value;
            const phone = document.getElementById('regPhone').value;
            if(!phone) return alert("–†–∞“õ–∞–º –ª–æ–∑–∏–º!");
            const snap = await db.ref('users/' + phone).once('value');
            const user = snap.val();
            if (user) { this.login(user); } else {
                const newUser = { name, phone, status: (phone === ADMIN_PHONE ? 'active' : 'pending') };
                await db.ref('users/' + phone).set(newUser);
                this.login(newUser);
            }
        },

        login(user) { localStorage.setItem('activeUser', JSON.stringify(user)); location.reload(); },
        logout() { localStorage.removeItem('activeUser'); location.reload(); },

        checkUserStatus() {
            if(!this.currentUser) return;
            document.getElementById('logoutLink').classList.remove('hidden');
            document.getElementById('userInfo').innerText = `üë§ ${this.currentUser.name}`;
            db.ref('users/' + this.currentUser.phone).on('value', snap => {
                if(snap.val()?.status === 'active') document.getElementById('addBtn').classList.remove('hidden');
            });
        },

        async addProduct() {
            const file = document.getElementById('pImg').files[0];
            let imgData = "";
            if(file) {
                imgData = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result);
                    reader.readAsDataURL(file);
                });
            }

            const product = {
                carBrand: document.getElementById('pCarBrand').value,
                carModel: document.getElementById('pCarModel').value,
                carYear: document.getElementById('pCarYear').value,
                type: document.getElementById('pType').value,
                name: document.getElementById('pName').value,
                price: parseFloat(document.getElementById('pPrice').value),
                qty: parseInt(document.getElementById('pQty').value),
                delivery: document.getElementById('pDelivery').value,
                warranty: document.getElementById('pWarranty').value,
                img: imgData,
                sellerPhone: this.currentUser.phone,
                sellerName: this.currentUser.name,
                date: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString().substring(0,5)
            };

            await db.ref('products').push(product);
            this.showPage('home');
        },

        loadProducts() {
            db.ref('products').on('value', snap => {
                this.allProducts = [];
                let myQty = 0;
                let mySum = 0;
                let grandTotal = 0;

                snap.forEach(child => {
                    const p = child.val();
                    p.id = child.key;
                    this.allProducts.push(p);
                    
                    const itemTotal = (p.price * p.qty);
                    grandTotal += itemTotal;

                    if(this.currentUser && p.sellerPhone === this.currentUser.phone) {
                        myQty += p.qty;
                        mySum += itemTotal;
                    }
                });

                if(this.currentUser) {
                    document.getElementById('userItemsCount').innerText = myQty;
                    document.getElementById('userTotalSum').innerText = mySum.toLocaleString() + " c.";
                    if(this.currentUser.phone === ADMIN_PHONE) {
                        document.getElementById('adminGrandTotal').innerText = grandTotal.toLocaleString() + " c.";
                    }
                }
                this.renderProducts(this.allProducts);
            });
        },

        renderProducts(list) {
            const grid = document.getElementById('adsGrid');
            grid.innerHTML = "";
            list.slice().reverse().forEach(p => {
                const isOwner = this.currentUser && (this.currentUser.phone === p.sellerPhone || this.currentUser.phone === 

ADMIN_PHONE);
                grid.innerHTML += `
                    <div class="card">
                        <span class="card-tag">${p.carBrand} ${p.carModel} (${p.carYear})</span>
                        <span class="type-tag">${p.type}</span>
                        <img src="${p.img || 'https://via.placeholder.com/300x180'}">
                        <div class="card-body">
                            ${isOwner ? `<button onclick="app.deleteP('${p.id}')" style="float:right; border:none; 

background:none; cursor:pointer">üóëÔ∏è</button>` : ''}
                            <h3 style="margin:0">${p.name}</h3>
                            <div class="price">${p.price} c.</div>
                            <div class="info-row"><span>üì¶ –ú–∏“õ–¥–æ—Ä:</span> <b>${p.qty} –∞–¥–∞–¥</b></div>
                            <div class="info-row"><span>üöö –î–æ—Å—Ç–∞–≤–∫–∞:</span> <b>${p.delivery}</b></div>
                            <div class="info-row"><span>üõ°Ô∏è –ö–∞—Ñ–æ–ª–∞—Ç:</span> <b>${p.warranty} —Ä”Ø–∑</b></div>
                            <div class="info-row"><span>üë§ –§—É—Ä”Ø—à–∞–Ω–¥–∞:</span> <b>${p.sellerName}</b></div>
                            <div class="info-row" style="color:#999; font-size:0.7rem">üìÖ –°–∞–Ω–∞: ${p.date}</div>
                            
                            <div class="btn-group">
                                <a href="tel:+992${p.sellerPhone}" class="btn-call">üìû –ó–∞–Ω–≥ –∑–∞–¥–∞–Ω</a>
                                <a href="https://wa.me/992${p.sellerPhone}" class="btn-wa">üí¨ WhatsApp</a>
                            </div>
                        </div>
                    </div>`;
            });
        },

        filterProducts() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('typeFilter').value;
            const filtered = this.allProducts.filter(p => {
                const searchStr = (p.name + p.carBrand + p.carModel).toLowerCase();
                const matchSearch = searchStr.includes(term);
                const matchType = type === "" || p.type === type;
                return matchSearch && matchType;
            });
            this.renderProducts(filtered);
        },

        loadAdminUsers() {
            document.getElementById('adminPanel').classList.remove('hidden');
            // –ú–æ “≥–∞–º –∏—Å—Ç–∏—Ñ–æ–¥–∞–±–∞—Ä–∞–Ω–¥–∞–≥–æ–Ω –≤–∞ “≥–∞–º –º–∞“≥—Å—É–ª–æ—Ç—Ä–æ –ø–∞–π–≤–∞—Å—Ç–∞ –Ω–∞–∑–æ—Ä–∞—Ç –º–µ–∫—É–Ω–µ–º
            db.ref('users').on('value', userSnap => {
                db.ref('products').on('value', prodSnap => {
                    const list = document.getElementById('allUsersList');
                    list.innerHTML = "";
                    
                    const products = [];
                    prodSnap.forEach(p => { products.push(p.val()); });

                    userSnap.forEach(c => {
                        const u = c.val();
                        
                        // “≤–∏—Å–æ–± –∫–∞—Ä–¥–∞–Ω–∏ –º–∞–±–ª–∞“ì–∏ —É–º—É–º–∏–∏ –º–∞“≥—Å—É–ª–æ—Ç–∏ “≥–∞–º–∏–Ω –∫–æ—Ä–±–∞—Ä
                        const userTotal = products
                            .filter(p => p.sellerPhone === u.phone)
                            .reduce((sum, p) => sum + (p.price * p.qty), 0);

                        list.innerHTML += `
                            <div class="user-row">
                                <span>
                                    <b>${u.name}</b> (${u.phone}) - [${u.status}] 
                                    <br>
                                    <small style="color:var(--success); font-weight:bold">üí∞ –ú–∞–±–ª–∞“ì–∏ –º–æ–ª“≥–æ: 

${userTotal.toLocaleString()} c.</small>
                                </span>
                                <div>
                                    ${u.status === 'pending' ? `<button onclick="app.updateUser('${u.phone}', 'active')" 

style="color:green; cursor:pointer; border:none; background:none; font-size:1.2rem">‚úÖ</button>` : ''}
                                    <button onclick="app.deleteUser('${u.phone}')" style="color:red; cursor:pointer; 

border:none; background:none; font-size:1.2rem">‚ùå</button>
                                </div>
                            </div>`;
                    });
                });
            });
        },

        updateUser(phone, status) { db.ref('users/' + phone).update({ status }); },
        deleteUser(phone) { if(confirm("–ò—Å—Ç–∏—Ñ–æ–¥–∞–±–∞—Ä–∞–Ω–¥–∞ –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞ —à–∞–≤–∞–¥?")) db.ref('users/' + phone).remove(); },
        deleteP(id) { if(confirm("–≠—ä–ª–æ–Ω –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞ —à–∞–≤–∞–¥?")) db.ref('products/' + id).remove(); }
    };

    app.init();
</script>
</body>
</html>
