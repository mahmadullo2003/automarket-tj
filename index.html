<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMarket Pro V6 - –ß–∞—Ç –≤–∞ –ú—É–æ—à–∏—Ä–∞—Ç</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #1a252f; --accent: #f39c12; --success: #27ae60; --bg: #f8f9fa; --card: #ffffff; --text: #333; }
        body.dark-mode { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --primary: #000; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 60px; transition: 0.3s; }
        
        nav { background: var(--primary); color: white; padding: 0.8rem 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .nav-links a { color: white; text-decoration: none; cursor: pointer; margin-left: 15px; font-weight: bold; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: var(--card); border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 1px solid #eee; }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        .card-body { padding: 15px; }

        /* –°—Ç–∏–ª–∏ –ß–ê–¢ */
        #chat-window { position: fixed; bottom: 0; right: 20px; width: 300px; height: 400px; background: var(--card); border-radius: 15px 15px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; z-index: 2000; transition: 0.3s; }
        .chat-header { background: var(--primary); color: white; padding: 10px; border-radius: 15px 15px 0 0; cursor: pointer; display: flex; justify-content: space-between; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.9rem; }
        .msg { margin-bottom: 8px; padding: 8px; border-radius: 8px; max-width: 80%; }
        .msg.sent { background: var(--success); color: white; align-self: flex-end; margin-left: auto; }
        .msg.received { background: #eee; color: #333; }
        .chat-input { display: flex; padding: 10px; border-top: 1px solid #eee; }
        .chat-input input { flex: 1; border: 1px solid #ddd; padding: 5px; border-radius: 5px; }

        .btn-chat { background: #9b59b6; color: white; padding: 8px; border-radius: 5px; text-align: center; font-size: 0.8rem; flex: 1; text-decoration: none; cursor: pointer; display: block; margin-top: 5px;}
        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav>
    <div onclick="app.showPage('home')" style="cursor:pointer; font-weight:bold; font-size:1.4rem">AutoMarket <span style="color:var(--accent)">V6</span></div>
    <div class="nav-links">
        <a onclick="app.showPage('home')">üè†</a>
        <a onclick="app.showPage('requests')">üîç</a>
        <a onclick="app.showPage('add')" id="addBtn" class="hidden">‚ûï</a>
        <a onclick="app.showPage('login')" id="loginLink">üîë</a>
    </div>
</nav>

<div class="container">
    <div id="homePage"><div id="adsGrid" class="ads-grid"></div></div>
    
    <div id="requestsPage" class="hidden">
        <h2>–î–∞—Ä—Ö–æ—Å—Ç“≥–æ</h2>
        <div id="requestsList"></div>
    </div>

    <div id="loginPage" class="hidden">
        <div style="max-width:300px; margin: 50px auto; background:white; padding:20px; border-radius:10px">
            <input type="text" id="uName" placeholder="–ù–æ–º" style="width:100%; margin-bottom:10px">
            <input type="number" id="uPhone" placeholder="–†–∞“õ–∞–º" style="width:100%; margin-bottom:10px">
            <button onclick="app.auth()" style="width:100%; background:var(--accent); color:white; border:none; padding:10px">–î–∞—Ä–æ–º–∞–¥</button>
        </div>
    </div>
</div>

<div id="chat-window" class="hidden">
    <div class="chat-header" onclick="document.getElementById('chat-window').classList.add('hidden')">
        <span id="chat-with-name">–ß–∞—Ç</span>
        <span>‚úñ</span>
    </div>
    <div id="chat-messages"></div>
    <div class="chat-input">
        <input type="text" id="chat-msg-input" placeholder="–ù–∞–≤–∏—Å–µ–¥...">
        <button onclick="app.sendMessage()" style="background:var(--success); color:white; border:none; border-radius:5px; margin-left:5px">‚û°</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCOYjoU34k2CDWVZd7D4XvhXAwgFK_LxlE",
        databaseURL: "https://automarkettj-default-rtdb.firebaseio.com",
        projectId: "automarkettj",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const app = {
        user: JSON.parse(localStorage.getItem('user_v1')),
        products: [],
        currentChatId: null,

        init() {
            this.loadProducts();
            this.updateUI();
        },

        updateUI() {
            if(this.user) {
                document.getElementById('loginLink').classList.add('hidden');
                document.getElementById('addBtn').classList.remove('hidden');
            }
        },

        showPage(id) {
            ['home', 'login', 'requests'].forEach(p => document.getElementById(p + 'Page').classList.add('hidden'));
            document.getElementById(id + 'Page').classList.remove('hidden');
        },

        // --- –õ–û–ì–ò–ö–ê–ò –ß–ê–¢ ---
        openChat(sellerPhone, sellerName) {
            if(!this.user) return alert("–ê–≤–≤–∞–ª –≤–æ—Ä–∏–¥ —à–∞–≤–µ–¥!");
            if(this.user.phone === sellerPhone) return alert("–®—É–º–æ –±–∞ —Ö—É–¥–∞—Ç–æ–Ω –Ω–∞–≤–∏—à—Ç–∞ –Ω–∞–º–µ—Ç–∞–≤–æ–Ω–µ–¥!");
            
            document.getElementById('chat-window').classList.remove('hidden');
            document.getElementById('chat-with-name').innerText = sellerName;
            
            // –°–æ—Ö—Ç–∞–Ω–∏ ID-–∏ —è–≥–æ–Ω–∞ –±–∞—Ä–æ–∏ —á–∞—Ç –±–∞–π–Ω–∏ –¥—É –Ω–∞—Ñ–∞—Ä
            this.currentChatId = [this.user.phone, sellerPhone].sort().join("_");
            this.loadMessages();
        },

        sendMessage() {
            const input = document.getElementById('chat-msg-input');
            const text = input.value.trim();
            if(!text || !this.currentChatId) return;

            const msgData = {
                sender: this.user.phone,
                senderName: this.user.name,
                text: text,
                time: Date.now()
            };

            db.ref(`chats/${this.currentChatId}`).push(msgData);
            input.value = "";
        },

        loadMessages() {
            db.ref(`chats/${this.currentChatId}`).on('value', snap => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = "";
                snap.forEach(c => {
                    const m = c.val();
                    const type = m.sender === this.user.phone ? 'sent' : 'received';
                    box.innerHTML += `<div class="msg ${type}"><b>${m.senderName}:</b><br>${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        },

        // --- –≠–™–õ–û–ù“≤–û ---
        loadProducts() {
            db.ref('products').on('value', snap => {
                const grid = document.getElementById('adsGrid');
                grid.innerHTML = "";
                snap.forEach(c => {
                    const p = c.val();
                    grid.innerHTML += `
                        <div class="card">
                            <img src="${p.img || 'https://via.placeholder.com/300x180'}">
                            <div class="card-body">
                                <h3>${p.name}</h3>
                                <div style="color:var(--success); font-weight:bold">${p.price} c.</div>
                                <div style="display:flex; gap:5px; margin-top:10px">
                                    <a href="tel:${p.phone}" style="background:#3498db; color:white; flex:1; text-align:center; padding:5px; border-radius:5px; text-decoration:none">–ó–∞–Ω–≥</a>
                                    <div class="btn-chat" onclick="app.openChat('${p.phone}', '${p.brand || '–§—É—Ä”Ø—à–∞–Ω–¥–∞'}')">–ß–∞—Ç üí¨</div>
                                </div>
                            </div>
                        </div>`;
                });
            });
        },

        auth() {
            const name = document.getElementById('uName').value;
            const phone = document.getElementById('uPhone').value;
            localStorage.setItem('user_v1', JSON.stringify({name, phone}));
            location.reload();
        }
    };

    app.init();
</script>
</body>
</html>
