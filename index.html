<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>“ö–∏—Å–º“≥–æ–∏ –≠“≥—Ç–∏—ë—Ç”£ (–ó–∞–ø—á–∞—Å—Ç) - Admin Panel</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --success: #27ae60; --wa: #25d366; --danger: #e74c3c; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--light); }
        
        /* Navbar & Burger Menu */
        nav { background: var(--primary); color: white; padding: 0 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 2000; height: 70px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .logo { font-size: 1.4rem; font-weight: bold; cursor: pointer; }
        .logo span { color: var(--accent); }
        
        .nav-links { display: flex; gap: 15px; align-items: center; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; cursor: pointer; transition: 0.3s; }
        .nav-links a:hover { color: var(--accent); }

        .burger { display: none; cursor: pointer; flex-direction: column; gap: 5px; }
        .burger div { width: 25px; height: 3px; background: white; border-radius: 5px; }

        /* General UI */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        
        .search-area { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        
        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); position: relative; transition: 0.3s; border: 1px solid #eee; }
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .card-body { padding: 15px; }
        .price-tag { color: var(--success); font-size: 1.4rem; font-weight: bold; margin: 10px 0; display: block; }
        
        .btn-action { width: 100%; padding: 12px; border-radius: 8px; margin-top: 8px; border: none; font-weight: bold; cursor: pointer; text-decoration: none; display: block; text-align: center; box-sizing: border-box; }
        
        .modal { background: white; padding: 30px; border-radius: 15px; width: 100%; max-width: 550px; margin: 0 auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .hidden { display: none !important; }

        input, select, textarea { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links { display: none; position: absolute; top: 70px; left: 0; width: 100%; background: var(--primary); flex-direction: column; padding: 20px 0; border-top: 1px solid #444; }
            .nav-links.active { display: flex; }
            .burger { display: flex; }
        }
    </style>
</head>
<body>

<nav>
    <div class="logo" onclick="app.showPage('home')">“ö–∏—Å–º“≥–æ<span>TJ</span></div>
    <div class="burger" onclick="document.querySelector('.nav-links').classList.toggle('active')">
        <div></div><div></div><div></div>
    </div>
    <div class="nav-links">
        <a onclick="app.showPage('home')">üè† –ê—Å–æ—Å”£</a>
        <a onclick="app.showPage('add')" id="addBtn" class="hidden">‚ûï –≠—ä–ª–æ–Ω–∏ –Ω–∞–≤</a>
        <a onclick="app.showPage('admin')" id="adminBtn" class="hidden" style="color:var(--accent)">‚öôÔ∏è –ê–¥–º–∏–Ω</a>
        <a onclick="app.showPage('login')" id="loginLink">üîë –í–æ—Ä–∏–¥—à–∞–≤”£</a>
        <a onclick="app.logout()" id="logoutLink" class="hidden">üö™ –ë–∞—Ä–æ–º–∞–¥</a>
    </div>
</nav>

<div class="container">
    <div id="homePage">
        <div class="search-area">
            <input type="text" id="searchName" placeholder="üîç –ù–æ–º–∏ “õ–∏—Å–º..." oninput="app.loadAds()">
            <select id="searchBrand" onchange="app.loadAds()">
                <option value="">“≤–∞–º–∞–∏ –º–∞—Ä–∫–∞“≥–æ</option>
            </select>
            <select id="searchType" onchange="app.loadAds()">
                <option value="">“≤–∞–º–∞–∏ –Ω–∞–º—É–¥“≥–æ</option>
                <option>–•–∞–¥–∞–≤–æ–π</option>
                <option>–≠–ª–µ–∫—Ç—Ä–æ–Ω”£</option>
                <option>–ö—É–∑–æ–≤</option>
                <option>–ú–∞—Ç–æ—Ä/–ö–æ—Ä–æ–±–∫–∞</option>
                <option>–î–∏–≥–∞—Ä</option>
            </select>
        </div>
        <div id="adsGrid" class="ads-grid"></div>
    </div>

    <div id="adminPage" class="hidden">
        <h2>üõ†Ô∏è –ò–¥–æ—Ä–∞–∫—É–Ω–∏–∏ –°–∏—Å—Ç–µ–º–∞</h2>
        <div class="stats-bar">
            <div class="stat-card">üë§ –ò—Å—Ç–∏—Ñ–æ–¥–∞–±–∞—Ä–∞–Ω–¥–∞–≥–æ–Ω: <b id="countUsers">0</b></div>
            <div class="stat-card">üì¶ “≤–∞–º–∞–∏ –º–∞“≥—Å—É–ª–æ—Ç: <b id="totalAdsCount">0</b></div>
            <div class="stat-card" style="border: 2px solid var(--success);">üí∞ –ù–∞—Ä—Ö–∏ —É–º—É–º”£: <b id="adminTotalValue">0</b> —Å.</div>
            <div class="stat-card">üü¢ –û–Ω–ª–∞–π–Ω: <b id="adminOnlineCount">0</b></div>
        </div>
        
        <div class="modal" style="max-width: 100%; margin-top: 20px;">
            <h3>–†”Ø–π—Ö–∞—Ç–∏ –∫–æ—Ä–±–∞—Ä–æ–Ω</h3>
            <input type="text" id="userSearch" placeholder="üîç “∂—É—Å—Ç—É“∑”Ø–∏ –∫–æ—Ä–±–∞—Ä (–Ω–æ–º —ë —Ç–µ–ª–µ—Ñ–æ–Ω)..." oninput="app.loadUsers()" style="margin-bottom: 15px;">
            <div id="adminUsersList"></div>
        </div>
    </div>

    <div id="addPage" class="hidden">
        <div class="modal">
            <h2>üì¶ –≠—ä–ª–æ–Ω–∏ “õ–∏—Å–º–∏ –Ω–∞–≤</h2>
            <label>–ú–∞—Ä–∫–∞–∏ –º–æ—à–∏–Ω</label>
            <select id="pCarBrand" onchange="app.updateModels()"></select>
            <label>–ú–æ–¥–µ–ª–∏ –º–æ—à–∏–Ω</label>
            <select id="pCarModel"></select>
            <label>–ù–∞–º—É–¥–∏ “õ–∏—Å–º</label>
            <select id="pPartType">
                <option>–•–∞–¥–∞–≤–æ–π</option>
                <option>–≠–ª–µ–∫—Ç—Ä–æ–Ω”£</option>
                <option>–ö—É–∑–æ–≤</option>
                <option>–ú–∞—Ç–æ—Ä/–ö–æ—Ä–æ–±–∫–∞</option>
                <option>–î–∏–≥–∞—Ä</option>
            </select>
            <label>–°–æ–ª–∏ –º–æ—à–∏–Ω</label>
            <input type="number" id="pYear" placeholder="–ú–∞—Å–∞–ª–∞–Ω: 2010">
            <label>–ù–æ–º–∏ “õ–∏—Å–º –≤–∞ –º–∞—ä–ª—É–º–æ—Ç</label>
            <textarea id="pDesc" placeholder="–ú–∞—Å–∞–ª–∞–Ω: –§–∞—Ä–∞“≥–æ–∏ Toyota Camry 50, “≥–æ–ª–∞—Ç–∏ –Ω–∞–≤..."></textarea>
            <label>–ù–∞—Ä—Ö (—Å–æ–º–æ–Ω”£)</label>
            <input type="number" id="pPrice">
            <label>–°—É—Ä–∞—Ç</label>
            <input type="file" id="pImg" accept="image/*">
            <button onclick="app.getLocation()" id="locBtn" class="btn-action" style="background:#3498db; color:white;">üìç –ú–∞–≤“õ–µ—ä—Ä–æ –º—É–∞–π—è–Ω –∫—É–Ω</button>
            <input type="hidden" id="pCoords">
            <button class="btn-action" style="background:var(--accent); color:white; margin-top:20px;" onclick="app.addProduct()">–ù–∞—à—Ä –∫–∞—Ä–¥–∞–Ω</button>
        </div>
    </div>

    <div id="loginPage" class="hidden">
        <div class="modal">
            <h2 id="authTitle">–í–æ—Ä–∏–¥—à–∞–≤”£</h2>
            <div id="regNameDiv" class="hidden"><label>–ù–æ–º–∏ —à—É–º–æ</label><input type="text" id="regName"></div>
            <label>–†–∞“õ–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω (–±–µ +992)</label><input type="number" id="regPhone" placeholder="933000000">
            <label>–†–∞–º–∑</label><input type="password" id="regPass">
            <button onclick="app.handleAuth()" class="btn-action" style="background:var(--success); color:white;">–î–∞–≤–æ–º –¥–æ–¥–∞–Ω</button>
            <p onclick="app.toggleAuthMode()" style="text-align:center; cursor:pointer; color:blue; margin-top:15px;">“ö–∞–π–¥–≥–∏—Ä”£</p>
        </div>
    </div>
</div>

<script>
    // –ö–û–ù–§–ò–ì–£–†–ê–¢–°–ò–Ø–ò FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyCOYjoU34k2CDWVZd7D4XvhXAwgFK_LxlE",
        authDomain: "automarkettj.firebaseapp.com",
        databaseURL: "https://automarkettj-default-rtdb.firebaseio.com",
        projectId: "automarkettj",
        storageBucket: "automarkettj.firebasestorage.app",
        messagingSenderId: "614498527268",
        appId: "1:614498527268:web:ff06a8f246df42ac1ad0b1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const app = {
        isAdmin: false,
        isLoginMode: true,
        carDatabase: {
            "Toyota": ["Camry", "Corolla", "Prado", "Rav4"],
            "Opel": ["Astra G", "Astra H", "Zafira", "Vectra"],
            "Mercedes-Benz": ["W210", "W211", "W212", "Sprinter"],
            "BMW": ["E39", "E60", "F10", "X5"],
            "Hyundai": ["Elantra", "Sonata", "Santa Fe"],
            "LADA": ["Priora", "Vesta", "2107", "Niva"]
        },

        init() {
            this.fillBrands();
            auth.onAuthStateChanged(async user => {
                if(user) {
                    db.ref('users/' + user.uid).on('value', snap => {
                        const u = snap.val();
                        this.isAdmin = u && u.role === 'admin';
                        if(this.isAdmin) {
                            document.getElementById('adminBtn').classList.remove('hidden');
                            this.loadUsers(); 
                        }
                    });

                    const statusRef = db.ref('users/' + user.uid + '/online');
                    db.ref('.info/connected').on('value', s => {
                        if(s.val()) { statusRef.onDisconnect().set(false); statusRef.set(true); }
                    });

                    document.getElementById('addBtn').classList.remove('hidden');
                    document.getElementById('logoutLink').classList.remove('hidden');
                    document.getElementById('loginLink').classList.add('hidden');
                }
            });
            this.loadAds();
            this.trackGlobal();
        },

        // –§—É–Ω–∫—Å–∏—è–∏ –±–æ—Ä–≥—É–∑–æ—Ä–∏–∏ –∫–æ—Ä–±–∞—Ä–æ–Ω –±–æ “≥–∏—Å–æ–±–∏ –º–∞–±–ª–∞“ì –≤–∞ —Ä–∞–º–∑
        loadUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            
            // –ê–≤–≤–∞–ª “≥–∞–º–∞–∏ —ç—ä–ª–æ–Ω“≥–æ—Ä–æ –º–µ–≥–∏—Ä–µ–º, —Ç–æ –º–∞–±–ª–∞“ì–∏ “≥–∞—Ä —è–∫ –∫–æ—Ä–±–∞—Ä—Ä–æ “≥–∏—Å–æ–± –∫—É–Ω–µ–º
            db.ref('products').on('value', adsSnap => {
                const userSales = {};
                adsSnap.forEach(ad => {
                    const data = ad.val();
                    if(data.uid) {
                        userSales[data.uid] = (userSales[data.uid] || 0) + Number(data.price || 0);
                    }
                });

                // –ê–∫–Ω—É–Ω —Ä”Ø–π—Ö–∞—Ç–∏ –∫–æ—Ä–±–∞—Ä–æ–Ω—Ä–æ –º–µ–±–∞—Ä–æ—Ä–µ–º
                db.ref('users').on('value', snap => {
                    const list = document.getElementById('adminUsersList');
                    if(!list) return;
                    list.innerHTML = ""; let count = 0;

                    snap.forEach(u => {
                        const val = u.val();
                        const uid = u.key;
                        const totalMoney = userSales[uid] || 0;

                        // “∂—É—Å—Ç—É“∑”Ø —Ç–∞–Ω“≥–æ –∞–∑ —Ä”Ø–∏ –†–ê“ö–ê–ú–ò –¢–ï–õ–ï–§–û–ù
                        if(!search || (val.phone && val.phone.includes(search))) {
                            count++;
                            list.innerHTML += `
                                <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center; background: white; margin-bottom: 5px; border-radius: 8px;">
                                    <div>
                                        <b style="font-size:1.1rem">${val.name || '–ë–µ –Ω–æ–º'}</b> ${val.online ? 'üü¢' : '‚ö™'}<br>
                                        <span>üìû –¢–µ–ª: <b>${val.phone || ''}</b></span><br>
                                        <span style="color:var(--danger)">üîë –†–∞–º–∑: <b>${val.pass || '***'}</b></span><br>
                                        <span style="color:var(--success)">üí∞ –ú–∞–±–ª–∞“ì–∏ —ç—ä–ª–æ–Ω“≥–æ: <b>${totalMoney.toLocaleString()} —Å.</b></span>
                                    </div>
                                    <div>
                                        ${val.role !== 'admin' ? `<button onclick="app.deleteUser('${uid}')" style="background:var(--danger); color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer;">–ë–ª–æ–∫</button>` : '<b>–ê–¥–º–∏–Ω</b>'}
                                    </div>
                                </div>`;
                        }
                    });
                    document.getElementById('countUsers').innerText = count;
                });
            });
        },

        async handleAuth() {
            const phone = document.getElementById('regPhone').value;
            const email = phone + "@zapchast.tj";
            const pass = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            try {
                if(this.isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, pass);
                } else {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    // –î–∞—Ä –±–∞–∑–∞–∏ users 'pass'-—Ä–æ –∏–ª–æ–≤–∞ –∫–∞—Ä–¥–µ–º, —Ç–æ –∞–¥–º–∏–Ω –±–∏–Ω–∞–¥
                    await db.ref('users/' + res.user.uid).set({ 
                        name: name, 
                        phone: phone, 
                        pass: pass, 
                        role: 'user', 
                        online: true 
                    });
                }
                this.showPage('home');
            } catch(e) { alert("–•–∞—Ç–æ: " + e.message); }
        },

        // –î–ò–ì–ê–† –§–£–ù–ö–°–ò–Ø“≤–û (fillBrands, updateModels, loadAds, showPage –≤–∞ “ì.) –ë–ï –¢–ê“í–ô–ò–†
        fillBrands() {
            const b = document.getElementById('pCarBrand');
            const sb = document.getElementById('searchBrand');
            Object.keys(this.carDatabase).forEach(k => {
                const opt = `<option value="${k}">${k}</option>`;
                b.innerHTML += opt;
                sb.innerHTML += opt;
            });
        },
        updateModels() {
            const b = document.getElementById('pCarBrand').value;
            const m = document.getElementById('pCarModel');
            m.innerHTML = "";
            if(this.carDatabase[b]) this.carDatabase[b].forEach(i => m.innerHTML += `<option value="${i}">${i}</option>`);
        },
        trackGlobal() {
            db.ref('users').on('value', snap => {
                let online = 0;
                snap.forEach(c => { if(c.val().online === true) online++ });
                if(document.getElementById('adminOnlineCount')) document.getElementById('adminOnlineCount').innerText = online;
            });
        },
        async loadAds() {
            const sName = document.getElementById('searchName').value.toLowerCase();
            const sBrand = document.getElementById('searchBrand').value;
            const sType = document.getElementById('searchType').value;
            db.ref('products').on('value', snap => {
                const grid = document.getElementById('adsGrid');
                grid.innerHTML = "";
                let totalSum = 0; let count = 0;
                snap.forEach(child => {
                    const p = child.val();
                    if((!sName || p.desc.toLowerCase().includes(sName)) && (!sBrand || p.brand === sBrand) && (!sType || p.type === sType)) {
                        count++; totalSum += Number(p.price || 0);
                        const isOwner = auth.currentUser && (auth.currentUser.uid === p.uid || this.isAdmin);
                        grid.innerHTML += `<div class="card">
                            ${isOwner ? `<button onclick="app.deleteAd('${child.key}')" style="position:absolute;right:10px;top:10px;background:red;color:white;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;z-index:10">üóëÔ∏è</button>` : ''}
                            <img src="${p.img || 'https://via.placeholder.com/300x200?text=No+Photo'}">
                            <div class="card-body">
                                <small style="color:var(--accent)">${p.type || ''} | ${p.brand} ${p.model}</small>
                                <h3 style="margin:5px 0">${p.brand} ${p.model}</h3>
                                <b class="price-tag">${p.price} —Å.</b>
                                <a href="tel:+992${p.phone}" class="btn-action" style="background:var(--primary); color:white;">üìû –ó–∞–Ω–≥</a>
                            </div>
                        </div>`;
                    }
                });
                if(document.getElementById('adminTotalValue')) document.getElementById('adminTotalValue').innerText = totalSum.toLocaleString();
                if(document.getElementById('totalAdsCount')) document.getElementById('totalAdsCount').innerText = count;
            });
        },
        showPage(id) {
            document.querySelectorAll('.container > div').forEach(p => p.classList.add('hidden'));
            document.getElementById(id + 'Page').classList.remove('hidden');
            if(id === 'admin') this.loadUsers();
        },
        toggleAuthMode() {
            this.isLoginMode = !this.isLoginMode;
            document.getElementById('authTitle').innerText = this.isLoginMode ? "–í–æ—Ä–∏–¥—à–∞–≤”£" : "“ö–∞–π–¥–≥–∏—Ä”£";
            document.getElementById('regNameDiv').classList.toggle('hidden', this.isLoginMode);
        },
        deleteAd(id) { if(confirm("–ù–µ—Å—Ç –∫–∞—Ä–¥–∞ —à–∞–≤–∞–¥?")) db.ref('products/' + id).remove(); },
        deleteUser(id) { if(confirm("–ë–ª–æ–∫ –∫–∞—Ä–¥–∞ —à–∞–≤–∞–¥?")) db.ref('users/' + id).remove(); },
        logout() { if(auth.currentUser) db.ref('users/' + auth.currentUser.uid + '/online').set(false); auth.signOut().then(() => location.reload()); }
    };

    app.init();
</script>
</body>
</html>
