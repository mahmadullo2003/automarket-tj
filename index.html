<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMarket Pro + Admin Panel</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    
    <style>
        :root { --primary: #1a252f; --accent: #f39c12; --success: #27ae60; --wa: #25d366; --danger: #e74c3c; --light: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); }

        nav { background: var(--primary); color: white; padding: 0 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 2000; height: 65px; }
        .logo { font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .logo span { color: var(--accent); }

        .burger { display: none; flex-direction: column; gap: 5px; cursor: pointer; border: none; background: none; }
        .burger div { width: 25px; height: 3px; background: white; border-radius: 2px; }

        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; cursor: pointer; }

        @media (max-width: 768px) {
            .burger { display: flex; }
            .nav-links { position: absolute; top: 65px; right: -100%; background: var(--primary); width: 250px; height: 100vh; flex-direction: column; padding: 30px; transition: 0.4s; }
            .nav-links.active { right: 0; }
            .nav-links a { width: 100%; padding: 15px 0; border-bottom: 1px solid #34495e; }
        }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 450px; margin: 10px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        label { font-size: 0.8rem; font-weight: bold; color: #666; margin-top: 12px; display: block; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        .btn-submit { width: 100%; padding: 14px; margin-top: 25px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; position: relative; }
        .card-body { padding: 15px; }
        
        /* –°—Ç–∏–ª–∏ –ê–¥–º–∏–Ω–∞ */
        .admin-badge { background: var(--danger); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px; }
        .admin-only { border: 2px solid var(--danger) !important; }
        .btn-delete { position: absolute; top: 10px; right: 10px; background: rgba(231, 76, 60, 0.9); color: white; border: none; padding: 8px; border-radius: 50%; cursor: pointer; z-index: 10; }
        
        .user-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }
        .btn-wa { background: var(--wa); color: white; text-decoration: none; display: block; text-align: center; padding: 10px; border-radius: 8px; margin-top: 5px; font-weight: bold; }
        .btn-call { background: var(--primary); color: white; text-decoration: none; display: block; text-align: center; padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: bold; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav>
    <div class="logo" onclick="app.showPage('home')">Auto<span>Market</span></div>
    <button class="burger" onclick="app.toggleMenu()"><div></div><div></div><div></div></button>
    <div class="nav-links" id="navLinks">
        <a onclick="app.showPage('home')">üè† –ê—Å–æ—Å”£</a>
        <a onclick="app.showPage('add')" id="addBtn" class="hidden">‚ûï –≠—ä–ª–æ–Ω</a>
        <a onclick="app.showPage('admin')" id="adminBtn" class="hidden" style="color:var(--danger)">‚öôÔ∏è –ê–¥–º–∏–Ω</a>
        <a onclick="app.showPage('login')" id="loginLink">üîë –í–æ—Ä–∏–¥—à–∞–≤”£</a>
        <a onclick="app.logout()" id="logoutLink" class="hidden">üö™ –ë–∞—Ä–æ–º–∞–¥</a>
    </div>
</nav>

<div class="container">
    <div id="homePage">
        <div id="adsGrid" class="ads-grid"></div>
    </div>

    <div id="adminPage" class="hidden">
        <div class="modal" style="max-width: 800px;">
            <h2>üõ†Ô∏è –ü–∞–Ω–µ–ª–∏ –∏–¥–æ—Ä–∞–∫—É–Ω–∏–∏ –ê–¥–º–∏–Ω</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button onclick="app.loadUsers()" style="padding: 10px; cursor: pointer;">üë• –ö–æ—Ä–±–∞—Ä–æ–Ω</button>
                <button onclick="app.showPage('home')" style="padding: 10px; cursor: pointer;">üì¶ “≤–∞–º–∞–∏ —ç—ä–ª–æ–Ω“≥–æ</button>
            </div>
            <div id="adminContent">
                <p>–ë–∞—Ä–æ–∏ –¥–∏–¥–∞–Ω–∏ —Ä”Ø–π—Ö–∞—Ç–∏ –∫–æ—Ä–±–∞—Ä–æ–Ω —Ç—É–≥–º–∞–∏ –±–æ–ª–æ—Ä–æ –ø–∞—Ö—à –∫—É–Ω–µ–¥.</p>
            </div>
        </div>
    </div>

    <div id="addPage" class="hidden">
        <div class="modal">
            <h2>üì¶ –≠—ä–ª–æ–Ω–∏ –Ω–∞–≤</h2>
            <label>–ú–∞—Ä–∫–∞</label><select id="pCarBrand" onchange="app.updateModels()"></select>
            <label>–ú–æ–¥–µ–ª</label><select id="pCarModel"></select>
            <label>–ù–æ–º–∏ –∑–∞–ø—á–∞—Å—Ç</label><input type="text" id="pName">
            <label>–ù–∞—Ä—Ö (—Å–æ–º–æ–Ω”£)</label><input type="number" id="pPrice">
            <label>–ú–∞–≤“õ–µ—ä</label>
            <button type="button" onclick="app.getLocation()" id="locBtn" style="width:100%; padding:8px; background:#eee; border:1px dashed #999;">üìç –ú—É–∞–π—è–Ω –∫–∞—Ä–¥–∞–Ω–∏ “∑–æ–π</button>
            <input type="hidden" id="pCoords">
            <label>–°—É—Ä–∞—Ç</label><input type="file" id="pImg" accept="image/*">
            <button class="btn-submit" onclick="app.addProduct()">–ù–∞—à—Ä –∫–∞—Ä–¥–∞–Ω</button>
        </div>
    </div>

    <div id="loginPage" class="hidden">
        <div class="modal">
            <h2 id="authTitle">–í–æ—Ä–∏–¥—à–∞–≤”£</h2>
            <div id="regNameDiv" class="hidden"><label>–ù–æ–º</label><input type="text" id="regName"></div>
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="number" id="regPhone">
            <label>–†–∞–º–∑</label><input type="password" id="regPass">
            <button class="btn-submit" style="background:var(--success)" onclick="app.handleAuth()">–î–∞–≤–æ–º –¥–æ–¥–∞–Ω</button>
            <p onclick="app.toggleAuthMode()" style="text-align:center; cursor:pointer; font-size:0.8rem">“ö–∞–π–¥ –∫–∞—Ä–¥–∞–Ω</p>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCOYjoU34k2CDWVZd7D4XvhXAwgFK_LxlE",
        authDomain: "automarkettj.firebaseapp.com",
        databaseURL: "https://automarkettj-default-rtdb.firebaseio.com",
        projectId: "automarkettj",
        storageBucket: "automarkettj.firebasestorage.app",
        messagingSenderId: "614498527268",
        appId: "1:614498527268:web:ff06a8f246df42ac1ad0b1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const app = {
        isLogin: true,
        isAdmin: false,
        carDatabase: {
            "Opel": ["Astra G", "Astra H", "Vectra B", "Vectra C", "Zafira"],
            "Toyota": ["Camry 50", "Camry 70", "Prado 150", "Land Cruiser 200"],
            "Mercedes-Benz": ["W210", "W211", "W212", "Sprinter", "G-Class"],
            "BMW": ["E39", "E60", "F10", "X5 E53", "X5 E70"],
            "Hyundai": ["Elantra", "Sonata", "Santa Fe", "Tucson"],
            "LADA": ["Priora", "Vesta", "Granta", "2107"]
        },

        init() {
            this.fillBrands();
            auth.onAuthStateChanged(async user => {
                if(user) {
                    const snap = await db.ref('users/' + user.uid).once('value');
                    const userData = snap.val();
                    this.isAdmin = userData && userData.role === 'admin';
                    
                    document.getElementById('addBtn').classList.remove('hidden');
                    document.getElementById('logoutLink').classList.remove('hidden');
                    document.getElementById('loginLink').classList.add('hidden');
                    if(this.isAdmin) document.getElementById('adminBtn').classList.remove('hidden');
                }
            });
            this.loadAds();
        },

        fillBrands() {
            const b = document.getElementById('pCarBrand');
            b.innerHTML = '<option value="">-- –ò–Ω—Ç–∏—Ö–æ–± --</option>';
            Object.keys(this.carDatabase).forEach(k => b.innerHTML += `<option value="${k}">${k}</option>`);
        },

        updateModels() {
            const b = document.getElementById('pCarBrand').value;
            const m = document.getElementById('pCarModel');
            m.innerHTML = "";
            if(this.carDatabase[b]) this.carDatabase[b].forEach(i => m.innerHTML += `<option value="${i}">${i}</option>`);
        },

        async loadUsers() {
            if(!this.isAdmin) return;
            const snap = await db.ref('users').once('value');
            let html = "<h3>–†”Ø–π—Ö–∞—Ç–∏ –∫–æ—Ä–±–∞—Ä–æ–Ω</h3>";
            snap.forEach(u => {
                const val = u.val();
                html += `
                    <div class="user-row">
                        <span>${val.name} (${val.phone}) ${val.role === 'admin' ? '<b>[Admin]</b>' : ''}</span>
                        ${val.role !== 'admin' ? `<button onclick="app.deleteUser('${u.key}')" style="color:red">–ë–ª–æ–∫</button>` : ''}
                    </div>`;
            });
            document.getElementById('adminContent').innerHTML = html;
        },

        async deleteUser(uid) {
            if(confirm("–ö–æ—Ä–±–∞—Ä—Ä–æ –±–ª–æ–∫ –∫–∞—Ä–¥–∞–Ω –º–µ—Ö–æ“≥–µ–¥?")) {
                await db.ref('users/' + uid).remove();
                this.loadUsers();
            }
        },

        async deleteAd(id) {
            if(confirm("–ò–Ω —ç—ä–ª–æ–Ω—Ä–æ –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞–Ω –º–µ—Ö–æ“≥–µ–¥?")) {
                await db.ref('products/' + id).remove();
            }
        },

        loadAds() {
            db.ref('products').on('value', snap => {
                const grid = document.getElementById('adsGrid');
                grid.innerHTML = "";
                snap.forEach(child => {
                    const p = child.val();
                    const isOwner = auth.currentUser && (auth.currentUser.uid === p.uid || this.isAdmin);
                    grid.innerHTML += `
                        <div class="card">
                            ${isOwner ? `<button class="btn-delete" onclick="app.deleteAd('${child.key}')">üóëÔ∏è</button>` : ''}
                            <img src="${p.img || 'https://via.placeholder.com/300x200'}" style="width:100%">
                            <div class="card-body">
                                <h3 style="margin:0">${p.name}</h3>
                                <b style="color:var(--success)">${p.price} c.</b>
                                <p style="font-size:0.8rem">${p.brand} ${p.model}</p>
                                <a href="tel:+992${p.phone}" class="btn-call">üìû –ó–∞–Ω–≥ –∑–∞–¥–∞–Ω</a>
                                <a href="https://wa.me/992${p.phone}" class="btn-wa">üí¨ WhatsApp</a>
                            </div>
                        </div>`;
                });
            });
        },

        // –§—É–Ω–∫—Å–∏—è“≥–æ–∏ –¥–∏–≥–∞—Ä (Auth, Location, Navigation) –±–µ—Ç–∞“ì–π–∏—Ä –º–æ–Ω–¥–∞–Ω–¥
        getLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('pCoords').value = `${pos.coords.latitude},${pos.coords.longitude}`;
                document.getElementById('locBtn').innerText = "‚úÖ –ú–∞–≤“õ–µ—ä —Å–∞–±—Ç —à—É–¥";
            });
        },
        async addProduct() {
            const file = document.getElementById('pImg').files[0];
            let img = "";
            if(file) {
                img = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result);
                    reader.readAsDataURL(file);
                });
            }
            await db.ref('products').push({
                brand: document.getElementById('pCarBrand').value,
                model: document.getElementById('pCarModel').value,
                name: document.getElementById('pName').value,
                price: document.getElementById('pPrice').value,
                coords: document.getElementById('pCoords').value,
                img: img,
                uid: auth.currentUser.uid,
                phone: auth.currentUser.email.split('@')[0]
            });
            this.showPage('home');
        },
        toggleMenu() { document.getElementById('navLinks').classList.toggle('active'); },
        showPage(id) {
            ['home', 'login', 'add', 'admin'].forEach(p => document.getElementById(p + 'Page').classList.add('hidden'));
            document.getElementById(id + 'Page').classList.remove('hidden');
            document.getElementById('navLinks').classList.remove('active');
        },
        toggleAuthMode() {
            this.isLogin = !this.isLogin;
            document.getElementById('authTitle').innerText = this.isLogin ? "–í–æ—Ä–∏–¥—à–∞–≤”£" : "“ö–∞–π–¥–≥–∏—Ä”£";
            document.getElementById('regNameDiv').classList.toggle('hidden', this.isLogin);
        },
        async handleAuth() {
            const email = document.getElementById('regPhone').value + "@auto.tj";
            const pass = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            try {
                if(this.isLogin) await auth.signInWithEmailAndPassword(email, pass);
                else {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.ref('users/' + res.user.uid).set({ name, phone: document.getElementById('regPhone').value, role: 'user' });
                }
                this.showPage('home');
            } catch(e) { alert(e.message); }
        },
        logout() { auth.signOut(); location.reload(); }
    };

    app.init();
</script>
</body>
</html>
