<script>
    // –ö–û–ù–§–ò–ì–£–†–ê–¢–°–ò–Ø–ò FIREBASE (“≤–∞–º–æ–Ω —Ç–∞–≤—Ä–µ –∫–∏ –±—É–¥)
    const firebaseConfig = {
        apiKey: "AIzaSyCOYjoU34k2CDWVZd7D4XvhXAwgFK_LxlE",
        authDomain: "automarkettj.firebaseapp.com",
        databaseURL: "https://automarkettj-default-rtdb.firebaseio.com",
        projectId: "automarkettj",
        storageBucket: "automarkettj.firebasestorage.app",
        messagingSenderId: "614498527268",
        appId: "1:614498527268:web:ff06a8f246df42ac1ad0b1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const app = {
        isAdmin: false,
        isLoginMode: true,
        carDatabase: {
            "Toyota": ["Camry", "Corolla", "Prado", "Rav4"],
            "Opel": ["Astra G", "Astra H", "Zafira", "Vectra"],
            "Mercedes-Benz": ["W210", "W211", "W212", "Sprinter"],
            "BMW": ["E39", "E60", "F10", "X5"],
            "Hyundai": ["Elantra", "Sonata", "Santa Fe"],
            "LADA": ["Priora", "Vesta", "2107", "Niva"]
        },

        init() {
            this.fillBrands();
            auth.onAuthStateChanged(async user => {
                if(user) {
                    // –°–∞–Ω“∑–∏—à–∏ –∞–¥–º–∏–Ω –¥–∞—Ä “≥–æ–ª–∞—Ç–∏ Realtime
                    db.ref('users/' + user.uid).on('value', snap => {
                        const u = snap.val();
                        this.isAdmin = u && u.role === 'admin';
                        
                        if(this.isAdmin) {
                            document.getElementById('adminBtn').classList.remove('hidden');
                            this.loadUsers(); // –ë–∞—Ä–æ–∏ –∞–¥–º–∏–Ω —Ä”Ø–π—Ö–∞—Ç–∏ –∫–æ—Ä–±–∞—Ä–æ–Ω—Ä–æ –º–µ–æ—Ä–∞–¥
                        }
                    });

                    // Presence (–°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω)
                    const statusRef = db.ref('users/' + user.uid + '/online');
                    db.ref('.info/connected').on('value', s => {
                        if(s.val()) { 
                            statusRef.onDisconnect().set(false); 
                            statusRef.set(true); 
                        }
                    });

                    document.getElementById('addBtn').classList.remove('hidden');
                    document.getElementById('logoutLink').classList.remove('hidden');
                    document.getElementById('loginLink').classList.add('hidden');
                }
            });
            this.loadAds();
            this.trackGlobal();
        },

        fillBrands() {
            const b = document.getElementById('pCarBrand');
            const sb = document.getElementById('searchBrand');
            Object.keys(this.carDatabase).forEach(k => {
                const opt = `<option value="${k}">${k}</option>`;
                b.innerHTML += opt;
                sb.innerHTML += opt;
            });
        },

        updateModels() {
            const b = document.getElementById('pCarBrand').value;
            const m = document.getElementById('pCarModel');
            m.innerHTML = "";
            if(this.carDatabase[b]) {
                this.carDatabase[b].forEach(i => m.innerHTML += `<option value="${i}">${i}</option>`);
            }
        },

        trackGlobal() {
            // –®—É–º–æ—Ä–∞–∏ –æ–Ω–ª–∞–π–Ω“≥–æ –±–∞—Ä–æ–∏ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω
            db.ref('users').on('value', snap => {
                let online = 0;
                snap.forEach(c => { if(c.val().online === true) online++ });
                if(document.getElementById('adminOnlineCount')) {
                    document.getElementById('adminOnlineCount').innerText = online;
                }
            });
        },

        async loadAds() {
            const sName = document.getElementById('searchName').value.toLowerCase();
            const sBrand = document.getElementById('searchBrand').value;
            const sType = document.getElementById('searchType').value;

            db.ref('products').on('value', snap => {
                const grid = document.getElementById('adsGrid');
                grid.innerHTML = "";
                let totalSum = 0; 
                let count = 0;

                snap.forEach(child => {
                    const p = child.val();
                    if((!sName || p.desc.toLowerCase().includes(sName)) &&
                       (!sBrand || p.brand === sBrand) &&
                       (!sType || p.type === sType)) {
                        
                        count++;
                        totalSum += Number(p.price || 0);
                        const isOwner = auth.currentUser && (auth.currentUser.uid === p.uid || this.isAdmin);
                        
                        grid.innerHTML += `
                            <div class="card">
                                ${isOwner ? `<button onclick="app.deleteAd('${child.key}')" style="position:absolute;right:10px;top:10px;background:red;color:white;border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;z-index:10">üóëÔ∏è</button>` : ''}
                                <img src="${p.img || 'https://via.placeholder.com/300x200?text=No+Photo'}">
                                <div class="card-body">
                                    <small style="color:var(--accent)">${p.type || ''} | ${p.brand} ${p.model} (${p.year || ''})</small>
                                    <h3 style="margin:5px 0">${p.brand} ${p.model}</h3>
                                    <p style="font-size:0.9rem; color:#666">${p.desc || ''}</p>
                                    <b class="price-tag">${p.price} —Å–æ–º–æ–Ω”£</b>
                                    <a href="tel:+992${p.phone}" class="btn-action" style="background:var(--primary); color:white;">üìû –ó–∞–Ω–≥ –∑–∞–¥–∞–Ω</a>
                                    ${p.coords ? `<a href="https://www.google.com/maps?q=${p.coords}" target="_blank" class="btn-action" style="background:#3498db; color:white;">üìç –ú–∞–≤“õ–µ—ä –¥–∞—Ä —Ö–∞—Ä–∏—Ç–∞</a>` : ''}
                                </div>
                            </div>`;
                    }
                });
                
                // –¢–ê–ù“≤–û –î–ê–† –ü–ê–ù–ï–õ–ò –ê–î–ú–ò–ù –ù–ê–ú–û–ò–® –î–û–î–ê–ù–ò –ú–ê–ë–õ–ê“í–ò –£–ú–£–ú”¢
                if(document.getElementById('adminTotalValue')) {
                    document.getElementById('adminTotalValue').innerText = totalSum.toLocaleString();
                }
                if(document.getElementById('totalAdsCount')) {
                    document.getElementById('totalAdsCount').innerText = count;
                }
            });
        },

        loadUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            // –ì”Ø—à –∫–∞—Ä–¥–∞–Ω–∏ —Ä”Ø–π—Ö–∞—Ç–∏ –∫–æ—Ä–±–∞—Ä–æ–Ω –¥–∞—Ä “≥–æ–ª–∞—Ç–∏ Realtime
            db.ref('users').on('value', snap => {
                const list = document.getElementById('adminUsersList');
                if(!list) return;
                list.innerHTML = ""; 
                let count = 0;

                snap.forEach(u => {
                    const val = u.val();
                    if(!search || (val.name && val.name.toLowerCase().includes(search)) || (val.phone && val.phone.includes(search))) {
                        count++;
                        list.innerHTML += `
                            <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <b>${val.name || '–ë–µ –Ω–æ–º'}</b> ${val.online ? '<span style="color:green">‚óè –æ–Ω–ª–∞–π–Ω</span>' : '<span style="color:gray">‚óè –æ—Ñ–ª–∞–π–Ω</span>'}<br>
                                    <small>üìû ${val.phone || ''} | –†–æ–ª: ${val.role || 'user'}</small>
                                </div>
                                <div>
                                    ${val.role !== 'admin' ? `<button onclick="app.deleteUser('${u.key}')" style="background:red; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">–ë–ª–æ–∫</button>` : '<b>–ê–¥–º–∏–Ω</b>'}
                                </div>
                            </div>`;
                    }
                });
                document.getElementById('countUsers').innerText = count;
            });
        },

        getLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('pCoords').value = `${pos.coords.latitude},${pos.coords.longitude}`;
                document.getElementById('locBtn').innerText = "‚úÖ –ú–∞–≤“õ–µ—ä —Å–∞–±—Ç —à—É–¥";
                document.getElementById('locBtn').style.background = "#27ae60";
            }, err => alert("–ú–∞–≤“õ–µ—ä –º—É–∞–π—è–Ω –Ω–∞—à—É–¥"));
        },

        async addProduct() {
            if(!auth.currentUser) return alert("–ê–≤–≤–∞–ª –≤–æ—Ä–∏–¥ —à–∞–≤–µ–¥!");
            const file = document.getElementById('pImg').files[0];
            let img = "";
            if(file) {
                img = await new Promise(r => {
                    const rd = new FileReader();
                    rd.onload = () => r(rd.result);
                    rd.readAsDataURL(file);
                });
            }
            await db.ref('products').push({
                brand: document.getElementById('pCarBrand').value,
                model: document.getElementById('pCarModel').value,
                type: document.getElementById('pPartType').value,
                year: document.getElementById('pYear').value,
                desc: document.getElementById('pDesc').value,
                price: document.getElementById('pPrice').value,
                coords: document.getElementById('pCoords').value,
                img: img,
                uid: auth.currentUser.uid,
                phone: auth.currentUser.email.split('@')[0]
            });
            alert("–ù–∞—à—Ä —à—É–¥!");
            this.showPage('home');
        },

        async handleAuth() {
            const phone = document.getElementById('regPhone').value;
            const email = phone + "@zapchast.tj";
            const pass = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            try {
                if(this.isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, pass);
                } else {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.ref('users/' + res.user.uid).set({ 
                        name: name, 
                        phone: phone, 
                        role: 'user', 
                        online: true 
                    });
                }
                this.showPage('home');
            } catch(e) { alert("–•–∞—Ç–æ: " + e.message); }
        },

        showPage(id) {
            document.querySelectorAll('.container > div').forEach(p => p.classList.add('hidden'));
            document.getElementById(id + 'Page').classList.remove('hidden');
            document.querySelector('.nav-links').classList.remove('active');
            if(id === 'admin') this.loadUsers();
        },

        toggleAuthMode() {
            this.isLoginMode = !this.isLoginMode;
            document.getElementById('authTitle').innerText = this.isLoginMode ? "–í–æ—Ä–∏–¥—à–∞–≤”£" : "“ö–∞–π–¥–≥–∏—Ä”£";
            document.getElementById('regNameDiv').classList.toggle('hidden', this.isLoginMode);
        },
        deleteAd(id) { if(confirm("–ù–µ—Å—Ç –∫–∞—Ä–¥–∞ —à–∞–≤–∞–¥?")) db.ref('products/' + id).remove(); },
        deleteUser(id) { if(confirm("–ò–Ω –∫–æ—Ä–±–∞—Ä—Ä–æ –±–ª–æ–∫ –º–µ–∫—É–Ω–µ–¥?")) db.ref('users/' + id).remove(); },
        logout() { 
            if(auth.currentUser) {
                db.ref('users/' + auth.currentUser.uid + '/online').set(false);
            }
            auth.signOut().then(() => location.reload()); 
        }
    };

    app.init();
</script>
