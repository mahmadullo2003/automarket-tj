<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoMarket Pro Max + Admin Panel</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    
    <style>
        :root { --primary: #1a252f; --accent: #f39c12; --success: #27ae60; --wa: #25d366; --danger: #e74c3c; --light: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); }
        nav { background: var(--primary); color: white; padding: 0 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 2000; height: 65px; }
        .logo { font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .logo span { color: var(--accent); }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; cursor: pointer; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .stats-bar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; flex: 1; min-width: 200px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; position: relative; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card-body { padding: 15px; }
        .btn-action { width: 100%; padding: 10px; border-radius: 8px; margin-top: 8px; border: none; font-weight: bold; cursor: pointer; text-decoration: none; display: block; text-align: center; }
        .btn-loc { background: #3498db; color: white; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 500px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .search-box { width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid var(--accent); border-radius: 8px; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .online-tag { color: #2ecc71; font-weight: bold; font-size: 0.9rem; margin-left: 15px; }
    </style>
</head>
<body>

<nav>
    <div class="logo" onclick="app.showPage('home')">Auto<span>Market</span></div>
    <div class="nav-links">
        <span class="online-tag">‚óè –û–Ω–ª–∞–π–Ω: <span id="onlineCount">0</span></span>
        <a onclick="app.showPage('home')">üè† –ê—Å–æ—Å”£ <span id="mainCount"></span></a>
        <a onclick="app.showPage('add')" id="addBtn" class="hidden">‚ûï –≠—ä–ª–æ–Ω</a>
        <a onclick="app.showPage('admin')" id="adminBtn" class="hidden" style="color:var(--danger)">‚öôÔ∏è –ê–¥–º–∏–Ω</a>
        <a onclick="app.showPage('login')" id="loginLink">üîë –í–æ—Ä–∏–¥—à–∞–≤”£</a>
        <a onclick="app.logout()" id="logoutLink" class="hidden">üö™ –ë–∞—Ä–æ–º–∞–¥</a>
    </div>
</nav>

<div class="container">
    <div id="homePage">
        <div class="stats-bar">
            <div class="stat-card">üõí –≠—ä–ª–æ–Ω“≥–æ: <b id="totalAds">0</b></div>
            <div class="stat-card">üí∞ –ù–∞—Ä—Ö–∏ —É–º—É–º”£: <b id="totalValue">0</b> —Å.</div>
        </div>
        <div id="adsGrid" class="ads-grid"></div>
    </div>

    <div id="adminPage" class="hidden">
        <div class="modal" style="max-width: 900px;">
            <h2>üõ†Ô∏è –ü–∞–Ω–µ–ª–∏ –ê–¥–º–∏–Ω</h2>
            <div class="stats-bar">
                <div class="stat-card">üë§ –ö–æ—Ä–±–∞—Ä–æ–Ω: <b id="countUsers">0</b></div>
                <div class="stat-card" style="border: 2px solid #2ecc71;">üü¢ –î–∞—Ä —Å–∞–π—Ç: <b id="adminOnlineCount">0</b></div>
                <div class="stat-card">üìà –°–∞—Ä–º–æ—è: <b id="adminTotalValue">0</b> —Å.</div>
            </div>
            <input type="text" class="search-box" id="userSearch" placeholder="üîç “∂—É—Å—Ç—É“∑”Ø–∏ –∫–æ—Ä–±–∞—Ä –±–æ —Ä–∞“õ–∞–º..." oninput="app.loadUsers()">
            <div id="adminContent"></div>
        </div>
    </div>

    <div id="addPage" class="hidden">
        <div class="modal">
            <h2>üì¶ –≠—ä–ª–æ–Ω–∏ –Ω–∞–≤</h2>
            <label>–ú–∞—Ä–∫–∞–∏ –º–æ—à–∏–Ω</label><select id="pCarBrand" onchange="app.updateModels()"></select>
            <label>–ú–æ–¥–µ–ª</label><select id="pCarModel"></select>
            <label>–ú–∞—ä–ª—É–º–æ—Ç –¥–∞—Ä –±–æ—Ä–∞–∏ “õ–∏—Å–º</label><textarea id="pDesc" placeholder="–ú–∞—Å–∞–ª–∞–Ω: –ú–∞—Ç–æ—Ä 1.6 –¥–∞—Ä “≥–æ–ª–∞—Ç–∏ —Ö—É–±..."></textarea>
            <label>–ù–∞—Ä—Ö (—Å–æ–º–æ–Ω”£)</label><input type="number" id="pPrice">
            <label>–ú–∞–≤“õ–µ—ä (üìç)</label>
            <button onclick="app.getLocation()" id="locBtn" style="padding:10px; width:100%; margin-top:5px;">üìç –ú—É–∞–π—è–Ω –∫–∞—Ä–¥–∞–Ω–∏ “∑–æ–π</button>
            <input type="hidden" id="pCoords">
            <label>–°—É—Ä–∞—Ç</label><input type="file" id="pImg" accept="image/*">
            <button class="btn-submit" style="width:100%; background:var(--accent); color:white; padding:15px; margin-top:20px; border:none; border-radius:8px; font-weight:bold;" onclick="app.addProduct()">–ù–∞—à—Ä –∫–∞—Ä–¥–∞–Ω</button>
        </div>
    </div>

    <div id="loginPage" class="hidden">
        <div class="modal">
            <h2 id="authTitle">–í–æ—Ä–∏–¥—à–∞–≤”£</h2>
            <div id="regNameDiv" class="hidden"><label>–ù–æ–º</label><input type="text" id="regName"></div>
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="number" id="regPhone" placeholder="933099029">
            <label>–†–∞–º–∑</label><input type="password" id="regPass">
            <button onclick="app.handleAuth()" style="width:100%; background:var(--success); color:white; padding:15px; margin-top:20px; border:none; border-radius:8px;">–î–∞–≤–æ–º –¥–æ–¥–∞–Ω</button>
            <p onclick="app.toggleAuthMode()" style="text-align:center; cursor:pointer; color:blue; margin-top:15px;">“ö–∞–π–¥ –∫–∞—Ä–¥–∞–Ω</p>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCOYjoU34k2CDWVZd7D4XvhXAwgFK_LxlE",
        authDomain: "automarkettj.firebaseapp.com",
        databaseURL: "https://automarkettj-default-rtdb.firebaseio.com",
        projectId: "automarkettj",
        storageBucket: "automarkettj.firebasestorage.app",
        messagingSenderId: "614498527268",
        appId: "1:614498527268:web:ff06a8f246df42ac1ad0b1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const app = {
        isAdmin: false,
        isLoginMode: true,
        carDatabase: {
            "Opel": ["Astra G", "Astra H", "Astra J", "Vectra B", "Vectra C", "Zafira A", "Zafira B", "Corsa"],
            "Toyota": ["Camry 35", "Camry 50", "Camry 55", "Camry 70", "Corolla", "Prado 120", "Prado 150", "Rav4"],
            "Mercedes-Benz": ["W124", "W210", "W211", "W212", "C-Class W202", "C-Class W203", "Sprinter", "ML-Class"],
            "BMW": ["E34", "E39", "E60", "F10", "G30", "X5 E53", "X5 E70", "X6"],
            "LADA": ["2101", "2106", "2107", "2109", "Priora", "Vesta", "Granta", "Niva"],
            "Hyundai": ["Elantra", "Sonata", "Accent", "Tucson", "Santa Fe"],
            "Kia": ["Optima", "K5", "Rio", "Sportage", "Sorento"],
            "Volkswagen": ["Golf 3", "Golf 4", "Passat B6", "Passat B7", "Jetta", "Touareg"],
            "Daewoo": ["Nexia 1", "Nexia 2", "Matiz", "Gentra"],
            "Lexus": ["RX300", "RX350", "LX470", "LX570", "ES350", "IS250"]
        },

        init() {
            this.fillBrands();
            auth.onAuthStateChanged(async user => {
                if(user) {
                    const userRef = db.ref('users/' + user.uid);
                    const snap = await userRef.once('value');
                    const u = snap.val();
                    this.isAdmin = u && u.role === 'admin';

                    // --- –°–ò–°–¢–ï–ú–ê–ò –û–ù–õ–ê–ô–ù ---
                    const statusRef = db.ref('users/' + user.uid + '/online');
                    const connectedRef = db.ref('.info/connected');
                    connectedRef.on('value', (snap) => {
                        if (snap.val() === true) {
                            statusRef.onDisconnect().set(false);
                            statusRef.set(true);
                        }
                    });

                    document.getElementById('addBtn').classList.remove('hidden');
                    document.getElementById('logoutLink').classList.remove('hidden');
                    document.getElementById('loginLink').classList.add('hidden');
                    
                    if(this.isAdmin) {
                        document.getElementById('adminBtn').classList.remove('hidden');
                        this.loadUsers();
                    }
                }
            });
            this.loadAds();
            this.trackOnlineStatus();
        },

        trackOnlineStatus() {
            db.ref('users').on('value', snap => {
                let onlineCount = 0;
                snap.forEach(child => {
                    if(child.val().online === true) onlineCount++;
                });
                document.getElementById('onlineCount').innerText = onlineCount;
                if(document.getElementById('adminOnlineCount')) {
                    document.getElementById('adminOnlineCount').innerText = onlineCount;
                }
            });
        },

        fillBrands() {
            const b = document.getElementById('pCarBrand');
            b.innerHTML = '<option value="">-- –ò–Ω—Ç–∏—Ö–æ–± --</option>';
            Object.keys(this.carDatabase).forEach(k => b.innerHTML += `<option value="${k}">${k}</option>`);
        },

        updateModels() {
            const b = document.getElementById('pCarBrand').value;
            const m = document.getElementById('pCarModel');
            m.innerHTML = "";
            if(this.carDatabase[b]) this.carDatabase[b].forEach(i => m.innerHTML += `<option value="${i}">${i}</option>`);
        },

        getLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('pCoords').value = `${pos.coords.latitude},${pos.coords.longitude}`;
                document.getElementById('locBtn').innerText = "‚úÖ –ú–∞–≤“õ–µ—ä —Å–∞–±—Ç —à—É–¥";
            });
        },

        async loadAds() {
            db.ref('products').on('value', snap => {
                const grid = document.getElementById('adsGrid');
                let total = 0, count = 0;
                grid.innerHTML = "";
                snap.forEach(child => {
                    const p = child.val();
                    total += Number(p.price);
                    count++;
                    const isOwner = auth.currentUser && (auth.currentUser.uid === p.uid || this.isAdmin);
                    grid.innerHTML += `
                        <div class="card">
                            ${isOwner ? `<button onclick="app.deleteAd('${child.key}')" style="position:absolute; top:10px; right:10px; background:red; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; z-index:100;">üóëÔ∏è</button>` : ''}
                            <img src="${p.img || 'https://via.placeholder.com/300x200'}" style="width:100%; height:200px; object-fit:cover;">
                            <div class="card-body">
                                <h3 style="margin:0">${p.name}</h3>
                                <b style="color:var(--success); font-size:1.2rem;">${p.price} —Å–æ–º–æ–Ω”£</b>
                                <p style="color:#666">${p.brand} ${p.model}</p>
                                <p style="font-size:0.85rem">${p.desc || ''}</p>
                                <a href="tel:+992${p.phone}" class="btn-action" style="background:var(--primary); color:white;">üìû –ó–∞–Ω–≥ –∑–∞–¥–∞–Ω</a>
                                <a href="https://wa.me/992${p.phone}" class="btn-action" style="background:var(--wa); color:white;">üí¨ WhatsApp</a>
                                ${p.coords ? `<a href="https://www.google.com/maps?q=${p.coords}" target="_blank" class="btn-action btn-loc">üìç –ú–∞–≤“õ–µ—ä –¥–∞—Ä —Ö–∞—Ä–∏—Ç–∞</a>` : ''}
                            </div>
                        </div>`;
                });
                document.getElementById('totalAds').innerText = count;
                document.getElementById('mainCount').innerText = `(${count})`;
                document.getElementById('totalValue').innerText = total.toLocaleString();
                if(this.isAdmin) document.getElementById('adminTotalValue').innerText = total.toLocaleString();
            });
        },

        async loadUsers() {
            const search = document.getElementById('userSearch').value;
            const snap = await db.ref('users').once('value');
            let html = "", count = 0;
            snap.forEach(u => {
                const val = u.val();
                if(!search || val.phone.includes(search)) {
                    count++;
                    const isOnline = val.online === true ? '<span style="color:#2ecc71">‚óè –æ–Ω–ª–∞–π–Ω</span>' : '<span style="color:#999">‚óè –æ—Ñ–ª–∞–π–Ω</span>';
                    html += `
                        <div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #eee; align-items:center;">
                            <div>
                                <b>${val.name}</b> ${isOnline}<br>
                                <small>üì± ${val.phone}</small>
                            </div>
                            <div>
                                ${val.role !== 'admin' ? `<button onclick="app.deleteUser('${u.key}')" style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">–ë–ª–æ–∫</button>` : '<b>–ê–¥–º–∏–Ω</b>'}
                            </div>
                        </div>`;
                }
            });
            document.getElementById('adminContent').innerHTML = html;
            document.getElementById('countUsers').innerText = count;
        },

        async addProduct() {
            const file = document.getElementById('pImg').files[0];
            let img = "";
            if(file) {
                img = await new Promise(r => {
                    const rd = new FileReader();
                    rd.onload = () => r(rd.result);
                    rd.readAsDataURL(file);
                });
            }
            await db.ref('products').push({
                brand: document.getElementById('pCarBrand').value,
                model: document.getElementById('pCarModel').value,
                name: document.getElementById('pName').value,
                desc: document.getElementById('pDesc').value,
                price: document.getElementById('pPrice').value,
                coords: document.getElementById('pCoords').value,
                img: img,
                uid: auth.currentUser.uid,
                phone: auth.currentUser.email.split('@')[0]
            });
            alert("–ù–∞—à—Ä —à—É–¥!");
            this.showPage('home');
        },

        async deleteAd(id) { if(confirm("–ù–µ—Å—Ç –∫–∞—Ä–¥–∞–Ω–∏ —ç—ä–ª–æ–Ω?")) await db.ref('products/' + id).remove(); },
        async deleteUser(uid) { if(confirm("–ë–ª–æ–∫ –∫–∞—Ä–¥–∞–Ω–∏ –∫–æ—Ä–±–∞—Ä?")) await db.ref('users/' + uid).remove(); },
        
        showPage(id) {
            ['home', 'login', 'add', 'admin'].forEach(p => document.getElementById(p + 'Page').classList.add('hidden'));
            document.getElementById(id + 'Page').classList.remove('hidden');
        },

        toggleAuthMode() {
            this.isLoginMode = !this.isLoginMode;
            document.getElementById('authTitle').innerText = this.isLoginMode ? "–í–æ—Ä–∏–¥—à–∞–≤”£" : "“ö–∞–π–¥–≥–∏—Ä”£";
            document.getElementById('regNameDiv').classList.toggle('hidden', this.isLoginMode);
        },

        async handleAuth() {
            const phone = document.getElementById('regPhone').value;
            const email = phone + "@auto.tj";
            const pass = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            try {
                if(this.isLoginMode) await auth.signInWithEmailAndPassword(email, pass);
                else {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.ref('users/' + res.user.uid).set({ name, phone, role: 'user', online: true });
                }
                this.showPage('home');
            } catch(e) { alert("–•–∞—Ç–æ–≥”£: " + e.message); }
        },

        logout() { auth.signOut(); location.reload(); }
    };

    app.init();
</script>
</body>
</html>
